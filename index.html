<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œå½¢ç”Ÿæ´»ææ¡ˆ - Gestalt Life Proposal</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­å®šå­—é«”ç‚º Interï¼Œä¸¦åŠ å…¥ä¸­æ–‡æ”¯æ´ (æ”¹ç‚º Noto Serif TC / æ€æºå®‹é«”) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Serif+TC:wght@200..900&display=swap');
        body {
            /* ä¸»è¦å­—é«”å¾ Noto Sans TC æ”¹ç‚º Noto Serif TC (æ˜é«”/å®‹é«”) */
            font-family: 'Noto Serif TC', 'Inter', serif; 
            
            /* ğŸ¨ ä¿æŒä½¿ç”¨ç¾æœ‰å…¬é–‹é€£çµçš„èƒŒæ™¯åœ–ç‰‡ */
            background-color: #A47963; /* åœ–ç‰‡è¼‰å…¥å¤±æ•—æ™‚çš„å‚™ç”¨è‰² */
            background-image: url('https://images.unsplash.com/photo-1549495034-728b7e283287?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'); 
            background-size: cover;
            background-attachment: fixed;
            background-position: center center;
            /* ----------------------- */
        }
        .task-type-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        
        /* ğŸ¨ å°‡æ‰€æœ‰åŸæ·±é’è‰² (#074F57) çš„åœ°æ–¹æ”¹ç‚º #A47963 */
        .bg-primary-dark { background-color: #A47963; } 
        .hover\:bg-primary-dark-hover:hover { background-color: #926A57; }
        
        /* Accent Medium ç¾åœ¨èˆ‡ Primary Dark é¡è‰²ç›¸åŒ */
        .bg-accent-medium { background-color: #A47963; } 
        .hover\:bg-accent-medium-hover:hover { background-color: #926A57; }
        
        .bg-ground-soft { background-color: #93B48B; }
        .hover\:bg-ground-soft-hover:hover { background-color: #7a9973; }
        
        /* ğŸ¨ å°ˆå±¬é¡è‰²å®šç¾© */
        .text-primary-dark { color: #A47963; } 
        .text-accent-medium { color: #A47963; } 
        .bg-end-conversation { background-color: #5A352A; } /* ğŸ‘ˆ æ–°å¢çµæŸå°è©±æŒ‰éˆ•çš„é¡è‰² */
        .hover\:bg-end-conversation-hover:hover { background-color: #492a21; }
        
        .border-ground-soft { border-color: #93B48B; }
        .bg-very-light-green { background-color: #f0f5ee; }

        /* éš±è—/é¡¯ç¤ºè¦–åœ–çš„åŸºç¤æ¨£å¼ */
        .view { display: none; }
        .view.active { display: block; }

        .emoji-button {
            transition: transform 0.1s ease-in-out, background-color 0.1s ease-in-out;
            color: #1f2937; /* é è¨­æ·±ç°å­— */
        }
        .emoji-button:hover {
            transform: scale(1.2);
        }
        .emoji-button.selected {
            background-color: #A47963;
            transform: scale(1.15);
            color: white; /* é¸ä¸­å¾Œè®Šç™½å­— */
        }
        /* Chat Bubble Styles */
        #chat-history-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 0.75rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼å®¹å™¨ (èƒŒæ™¯ç‚ºç™½è‰²ï¼Œåœ¨ #A47963 åº•è‰²ä¸Šæ¸…æ™°æµ®ç¾) -->
    <div id="app-container" class="w-full max-w-lg bg-white rounded-3xl shadow-xl overflow-hidden transform transition-all duration-300">
        
        <!-- æ¨™é¡Œå€ (BG: #A47963) -->
        <header class="bg-primary-dark p-6">
            <h1 class="text-3xl font-extrabold text-white text-center">å®Œå½¢ç”Ÿæ´»ææ¡ˆ</h1>
            <p class="text-sm text-gray-200 text-center mt-1">Gestalt Life Proposal</p>
        </header>

        <!-- å…§å®¹é¡¯ç¤ºå€ -->
        <main class="p-6 md:p-8">
            
            <!-- è¦–åœ–å®¹å™¨ -->
            <div id="views-container" class="space-y-6">

                <!-- 1. èµ·å§‹ç•«é¢ (VIEW_HOME) -->
                <div id="view-home" class="view active">
                    <div class="min-h-[150px] flex flex-col justify-center items-center text-center p-6 rounded-xl transition-all duration-500">
                        <p class="text-xl text-gray-700 font-semibold mb-6">æ­¡è¿ä¾†åˆ°å®Œå½¢è¦ºå¯Ÿçš„æ­¤åˆ»ã€‚</p>
                        
                        <!-- å°è¦½æŒ‰éˆ• -->
                        <div class="space-y-4 w-full">
                            <!-- ğŸ¨ BG: #93B48B, Text: White (ä¾æ“šè¦æ±‚) -->
                            <button onclick="switchView('random-tools')" class="w-full px-4 py-3 bg-ground-soft text-white font-bold text-lg rounded-xl shadow-lg hover:bg-ground-soft-hover transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98]">
                                æˆ‘æƒ³éš¨æ©Ÿç²å¾—è¡Œå‹•æŒ‡ä»¤
                            </button>
                            <!-- ğŸ¨ BG: #A47963 -->
                            <button onclick="switchView('ai-interaction')" class="w-full px-4 py-3 bg-accent-medium text-white font-bold text-lg rounded-xl shadow-lg hover:bg-accent-medium-hover transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98]">
                                æˆ‘æƒ³è·Ÿå®Œå½¢è¡Œè€…å°è©± <!-- ğŸ‘ˆ å·²æ›´æ–°åç¨± -->
                            </button>
                        </div>

                        <p class="text-sm text-gray-500 mt-6">è«‹é¸æ“‡ä½ ç•¶ä¸‹æƒ³åšçš„è¦ºå¯Ÿç·´ç¿’ã€‚</p>
                    </div>
                </div>

                <!-- 2. éš¨æ©ŸæŒ‡ä»¤ç•«é¢ (VIEW_RANDOM_TOOLS) -->
                <div id="view-random-tools" class="view">
                    <!-- é¡¯ç¤ºå¡ç‰‡ -->
                    <div id="display-card-random" class="min-h-[150px] flex flex-col justify-center items-center text-center bg-very-light-green border border-ground-soft p-6 rounded-xl shadow-inner transition-all duration-500">
                        <div id="message-content-random">
                            <p class="text-lg text-gray-500 mb-4">è«‹é¸æ“‡ä¸‹æ–¹æŒ‡ä»¤ï¼Œé–‹å§‹è¦ºå¯Ÿã€‚</p>
                        </div>
                    </div>
                    
                    <!-- ğŸ’¡ è¦ºå¯Ÿå°ç™¼ç¾ (äº’å‹•å›é¥‹å€å¡Š) -->
                    <div id="task-interaction-area" class="mt-6 p-4 bg-gray-50 rounded-xl border border-gray-200 hidden">
                        <!-- å‹•æ…‹å…§å®¹å°‡æœƒè¢«æ’å…¥æ­¤è™• -->
                    </div>
                    
                    <!-- ğŸ–¼ï¸ åœ–ç‰‡çµæœå€å¡Š (æ–°å¢) -->
                    <div id="image-result-area" class="mt-6">
                        <!-- åœ–ç‰‡å’Œè¼‰å…¥ç‹€æ…‹æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>

                    <!-- æŒ‰éˆ•æ“ä½œå€ -->
                    <div class="mt-6 space-y-4">
                        <!-- æ ¸å¿ƒåŠŸèƒ½ä¸€ï¼šå®Œå½¢å¤§å¸«çš„ç¶“å…¸èªéŒ„ (BG: #A47963) -->
                        <button id="quote-button" class="w-full flex items-center justify-center px-4 py-3 bg-primary-dark text-white font-bold text-lg rounded-xl shadow-lg hover:bg-primary-dark-hover transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-[#93B48B]">
                            <span class="mr-2 text-xl">âœ¨</span> å®Œå½¢å¤§å¸«çš„ç¶“å…¸èªéŒ„
                        </button>
                        
                        <!-- æ ¸å¿ƒåŠŸèƒ½äºŒï¼šè¦ºå¯Ÿè¡Œå‹•æŒ‡ä»¤ (BG: #93B48B, Text: White) -->
                        <button id="task-button" class="w-full flex items-center justify-center px-4 py-3 bg-ground-soft text-white font-bold text-lg rounded-xl shadow-lg hover:bg-ground-soft-hover transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-[#a8c99f]">
                            <span class="mr-2 text-xl">ğŸŒªï¸</span> å®Œå½¢çš„è¦ºå¯Ÿè¡Œå‹•
                        </button>
                    </div>
                    
                    <button onclick="switchView('home', 'random')" class="mt-6 w-full text-sm text-gray-500 hover:text-primary-dark transition duration-150 py-2 rounded-lg border border-gray-300 hover:border-primary-dark">â† è¿”å›èµ·å§‹é </button>
                </div>

                <!-- 3. ç…©æƒ±äº’å‹•ç•«é¢ (VIEW_AI_INTERACTION) -->
                <div id="view-ai-interaction" class="view">
                    
                    <!-- å°è©±æ­·å²å®¹å™¨ -->
                    <div id="chat-history-container" class="min-h-[150px] space-y-4 p-4 bg-very-light-green border border-ground-soft transition-all duration-500">
                        <p id="chat-initial-message" class="text-lg text-gray-500 mb-4 text-center">å®Œå½¢è¡Œè€…æ­£åœ¨ç­‰å€™æ‚¨çš„é‚€è«‹ã€‚</p> <!-- ğŸ‘ˆ å·²æ›´æ–°æ–‡å­— -->
                    </div>

                    <!-- è‰²ç¥¨çµæœå€å¡Š (é è¨­éš±è—) -->
                    <div id="palette-result-area" class="mt-6 p-4 bg-gray-50 rounded-xl border border-gray-200 hidden">
                        <!-- å°ˆå±¬è‰²ç¥¨å°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>

                    <!-- äº’å‹•è¼¸å…¥å€åŸŸ (Chat Input) -->
                    <div id="chat-input-area" class="mt-6 space-y-3 p-4 bg-gray-50 rounded-xl border border-gray-200">
                        <label for="user-concern" class="block text-sm font-bold text-gray-700">ğŸ’¬ å¯«ä¸‹ä½ ç¾åœ¨çš„ç…©æƒ±æˆ–ç•¶ä¸‹æ„Ÿå—ï¼š</label>
                        <textarea id="user-concern" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#A47963] focus:border-[#A47963] transition duration-150 text-gray-800" placeholder="ä¾‹å¦‚ï¼šæˆ‘å°æœŸæœ«å ±å‘Šæ„Ÿåˆ°éå¸¸ç„¦æ…®ï¼Œè¦ºå¾—è‡ªå·±åšä¸åˆ°..."></textarea>
                        <!-- æäº¤æŒ‰éˆ• (BG: #A47963) -->
                        <button id="submit-concern-button" class="w-full flex items-center justify-center px-4 py-3 bg-accent-medium text-white font-bold text-lg rounded-xl shadow-lg hover:bg-accent-medium-hover transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-[#93B48B] disabled:opacity-50" disabled>
                            <div id="concern-spinner" class="hidden animate-spin h-5 w-5 mr-3 border-2 border-white border-t-transparent rounded-full"></div>
                            <span id="concern-button-text">æ¥æ”¶å®Œå½¢å›æ‡‰</span>
                        </button>
                    </div>
                    
                    <!-- çµæŸå°è©±æŒ‰éˆ• (æ–°å¢) -->
                    <!-- ğŸ¨ é¡è‰²æ”¹ç‚º #5A352A -->
                    <button id="end-conversation-button" class="mt-6 w-full text-sm text-white font-bold px-4 py-3 bg-end-conversation rounded-xl shadow-md hover:bg-end-conversation-hover transition duration-150 focus:outline-none focus:ring-4 focus:ring-[#926A57] hidden" onclick="handleEndConversation()">
                        çµæŸæœ¬æ¬¡å°è©±
                    </button>

                    <!-- éŒ¯èª¤/æç¤ºè¨Šæ¯ -->
                    <div id="status-message" class="mt-4 text-center text-gray-600 hidden"></div> <!-- èª¿æ•´ç‚ºä¸­æ€§é¡è‰²ï¼Œç”¨æ–¼æç¤º -->

                    <button onclick="switchView('home', 'ai')" class="mt-4 w-full text-sm text-gray-500 hover:text-primary-dark transition duration-150 py-2 rounded-lg border border-gray-300 hover:border-primary-dark">â† è¿”å›èµ·å§‹é </button>
                </div>

            </div>

        </main>
        <!-- Footer ç§»é™¤ï¼ŒæŒ‰éˆ•å·²ç§»è‡³å„è¦–åœ–å…§ -->

    </div>

    <script>
        // === å…¨åŸŸè®Šæ•¸å®£å‘Š (ç”¨æ–¼å„²å­˜ DOM å…ƒç´ ) ===
        let chatHistory = [];
        let currentSelectedEmoji = null; 
        let chatRound = 0; // æ–°å¢å°è©±å›åˆè¨ˆæ•¸å™¨
        
        let displayCardRandom;
        let messageContentRandom;
        let quoteButton;
        let taskButton;
        let taskInteractionArea; 
        let imageResultArea; 
        
        let userConcernInput;
        let submitConcernButton;
        let concernSpinner;
        let concernButtonText;
        let statusMessage;
        let endConversationButton;
        let paletteResultArea;
        let chatInputArea;
        let chatHistoryContainer;

        const views = {
            'home': null,
            'random-tools': null,
            'ai-interaction': null
        };
        
        // --- å®Œå½¢åè¨€æ•¸æ“š (ç•¥) ---
        const gestaltQuotes = [
            { quote: "æˆ‘åšæˆ‘çš„äº‹ï¼Œä½ åšä½ çš„äº‹ã€‚", author: "Fritz Perls" },
            { quote: "å¤±å»ç†æ™ºï¼Œæ‰¾å›æ„Ÿå®˜ã€‚ (Lose your mind and come to your senses.)", author: "Fritz Perls" },
            { quote: "ç„¦æ…®æ˜¯å¾ã€ç¾åœ¨ã€åˆ°ã€æœªä¾†ã€ä¹‹é–“çš„ç¸«éš™ã€‚", author: "Fritz Perls" },
            { quote: "æ´»åœ¨ç•¶ä¸‹ã€‚", author: "Fritz Perls" },
            { quote: "è²¬ä»»ï¼Œæ˜¯ä½ å¯ä»¥å›æ‡‰çš„èƒ½åŠ›ã€‚", author: "Fritz Perls" },
            { quote: "å”¯æœ‰é«”é©—æ‰èƒ½äº†è§£ã€‚", author: "Fritz Perls" },
            { quote: "è¦ºå¯Ÿå³ç™‚ç™’ã€‚", author: "Fritz Perls" },
            { quote: "å®Œæˆæœªç«Ÿäº‹å‹™ã€‚", author: "Fritz Perls" },
            { quote: "æ¥è§¸èˆ‡é€€ç¸®çš„ç¯€å¥ã€‚", author: "Fritz Perls" },
            { quote: "å¾ã€æ‡‰è©²ã€è½‰å‘ã€æ˜¯ã€ã€‚", author: "Fritz Perls" },
            { quote: "ä¸€å€‹äººç•¶ä»–å‚¾å‘æŠ•å°„æ™‚ï¼Œå°±å¥½åƒæŸäººååœ¨æˆ¿å­è£¡é¢ï¼Œå‰é¢æ˜¯ä¸€é¢é¡å­ï¼Œæ¯ç•¶ä»–å¾€å¤–çœ‹ï¼Œä»–ä»¥ç‚ºå¾ç»ç’ƒçœ‹åˆ°å¤–é¢çš„ä¸–ç•Œï¼Œäº‹å¯¦ä¸Šä»–çœ‹åˆ°çš„æŒ‡æ˜¯ä»–è‡ªå·±", author: "Fritz Perls" },
            
            // è¬æ›œä»»è€å¸«èªéŒ„ (New)
            { quote: "æ˜¯ä»€éº¼é˜»æ“‹äº†ä½ ï¼Ÿ", author: "è¬æ›œä»»" },
            { quote: "å¾ˆå¥½å–”ï¼", author: "è¬æ›œä»»" },
            { quote: "å®Œå½¢çš„æ ¸å¿ƒä¸æ˜¯ã€Œæ²»ç™‚ã€ï¼Œè€Œæ˜¯ã€Œè›»è®Šã€", author: "è¬æ›œä»»" },
            { quote: "Gestalt æœ¬é«”æ˜¯ã€Œé“ã€ï¼šè‡ªç„¶é‹ä½œçš„ç™‚ç™’æ€§ï¼Œäººå¤©ç”Ÿå°±æœ‰ç™‚ç™’è‡ªå·±çš„èƒ½åŠ›ï¼Œæ²»ç™‚åœ¨åšçš„æ˜¯æ¬é–‹å¡ä½è‡ªå·±çš„éƒ¨åˆ†", author: "è¬æ›œä»»" },
            { quote: "åœ¨é—œä¿‚ç•¶ä¸­ï¼Œè¦ªå¯†èˆ‡è‡ªä¸»æ°¸é æ˜¯å€‹é‡è¦è­°é¡Œ", author: "è¬æ›œä»»" },
            { quote: "å¸¶è‘—è¦ºå¯Ÿäº†è§£ä½•è¬‚éå»ã€ä½•è¬‚ç¾åœ¨ã€å·®åˆ¥ç‚ºä½•ï¼Œå³æ˜¯æ”¹è®Šçš„åŸºç¤", author: "è¬æ›œä»»" },
            { quote: "å®Œå½¢çš„æ­·ç¨‹ä¸æ˜¯ã€Œæƒ³ã€å‡ºä¾†çš„ã€ŒæŠ€å·§ã€ï¼Œè€Œæ˜¯åœ¨ç•¶ä¸‹è·Ÿå€‹æ¡ˆäº’å‹•å‡ºä¾†çš„", author: "è¬æ›œä»»" },
            { quote: "è¶Šä¾†è¶Šæ¥è¿‘æ¨¡ç³Šã€è¶Šä¾†è¶Šç„¡çŸ¥ï¼Œä½†è¶Šä¾†è¶Šæœ‰åŠ›é‡ã€è¶Šä¾†è¶Šèƒ½å¤ è·Ÿæ›´å¤§çš„æˆ‘ç›¸è™•ã€æ•´åˆ", author: "è¬æ›œä»»" },
            { quote: "éå»å¡ä½çš„äº‹æƒ…ä¸€å®šå°æ–¼ç•¶æ™‚æœ‰åŠŸèƒ½ï¼Œé€²ä¸€æ­¥å»ç­è§£ã€Œå¡ã€æƒ³è¦å¹«åŠ©æˆ‘ä»€éº¼", author: "è¬æ›œä»»" },
            { quote: "ä½æ„Ÿè¦ºæ˜¯æ¥è§¸å¹²æ“¾ä¸­æœ€ç‚ºåš´é‡çš„ï¼Œæ˜¯ä¸€ç¨®è®“è‡ªå·±èº«é«”éº»æœ¨çš„éç¨‹", author: "è¬æ›œä»»" },
            
            // Enright èªéŒ„ (New)
            { quote: "å®Œå½¢æ²»ç™‚çš„ä¸€å€‹æ ¸å¿ƒç‰¹è‰²ï¼Œå³æ˜¯æ¡ˆä¸»ç›¡å¯èƒ½çš„è‡ªå·±æ²»ç™‚è‡ªå·±", author: "Enright (1971, p.120)" },
        ];

        // --- è¦ºå¯Ÿè¡Œå‹•æŒ‡ä»¤æ•¸æ“š (ç•¥) ---
        const awarenessTasks = [
            { type: 'æ„Ÿå®˜è¦ºå¯Ÿ', color: 'bg-[#f0f5ee] text-accent-medium', tasks: ["é–‰ä¸Šçœ¼ï¼Œæ‰¾å‡ºç©ºæ°£ä¸­ä¸‰ç¨®ä¸åŒçš„å‘³é“ã€‚", "å°ˆæ³¨è†è½å‘¨é­æœ€å¾®å¼±çš„è²éŸ³ï¼ŒæŒçºŒ 30 ç§’.", "è¼•è¼•è§¸æ‘¸ä½ çš„æŒ‡å°–ï¼Œæ„Ÿå—å®ƒå€‘çš„æº«åº¦å’Œç´‹ç†ã€‚", "èˆ”ä¸€ä¸‹å˜´å”‡ï¼Œæ„Ÿå—å£ä¸­çš„å”¾æ¶²å’Œæº«åº¦."] },
            { type: 'èº«é«”è¦ºå¯Ÿ', color: 'bg-[#d0e6ec] text-accent-medium', tasks: ["ç¾åœ¨æ·±å¸ä¸€å£æ°£ï¼Œæ„Ÿå—æ°£é«”æ˜¯åœåœ¨èƒ¸å£é‚„æ˜¯é€²åˆ°è‚šå­ï¼Ÿ", "ç·©æ…¢åœ°è³èµ·ä½ çš„è‚©è†€ï¼Œç„¶å¾Œè®“å®ƒå€‘å®Œå…¨æ”¾é¬†ï¼Œé‡è¤‡ä¸‰æ¬¡ã€‚", "å°‡ä½ çš„æ³¨æ„åŠ›æ”¾åœ¨å·¦è…³è…³è¶¾ï¼Œæ„Ÿå—å®ƒå€‘èˆ‡åœ°é¢çš„æ¥è§¸ã€‚", "å‹•ä¸€å‹•ä½ æœ€åƒµç¡¬çš„éƒ¨ä½ï¼Œç„¶å¾Œå‘Šè¨´å®ƒï¼šã€è¬è¬ä½ ç‚ºæˆ‘æ‰¿è¼‰çš„å£“åŠ›ã€‚ã€"] },
            { type: 'ç’°å¢ƒæ¥è§¸', color: 'bg-[#fcf5e0] text-accent-medium', tasks: ["æ‰¾å‡ºèº«é‚Š 5 å€‹è—è‰²çš„æ±è¥¿ï¼Œä¸¦è§¸æ‘¸å…¶ä¸­ä¸€å€‹ã€‚", "çœ‹è‘—ä½ å‰æ–¹çš„ä¸€å€‹ç‰©é«”ï¼Œæè¿°å®ƒçš„é‚Šç•Œå’ŒèƒŒæ™¯çš„é—œä¿‚ã€‚", "åœ¨å¿ƒä¸­ç‚ºä½ èº«é‚Šçš„ä¸€ä»¶ç‰©å“å‘½åï¼Œä¸¦èªªå‡ºå®ƒç¾åœ¨å°ä½ çš„æ„ç¾©ã€‚", "æ‰¾ä¸€å€‹å…‰æºï¼Œå‡è¦–å®ƒä¸€ç§’é˜ï¼Œç„¶å¾Œé–‰ä¸Šçœ¼æ„Ÿå—æ®˜å½±."] },
            { type: 'èªæ„è½‰åŒ–', color: 'bg-[#e6e0f3] text-accent-medium', tasks: ["æŠŠæˆ‘å‰›å‰›èªªçš„ã€æˆ‘ä¸èƒ½...ã€æ”¹æˆã€æˆ‘ä¸é¡˜æ„...ã€ï¼Œå†èªªä¸€æ¬¡æ„Ÿå—çœ‹çœ‹ã€‚", "å°‡ä½ ç¾åœ¨æœ€å¸¸ä½¿ç”¨çš„å‹•è©æ”¹ç‚ºä¸€å€‹æ›´ä¸»å‹•çš„å‹•è©ï¼Œä¸¦å¯«ä¸‹ä¾†ã€‚", "èªªå‡ºã€æˆ‘é¸æ“‡...ã€ä¾†æè¿°ä½ ä»Šå¤©çš„æŸå€‹è¡Œå‹•ï¼Œå–ä»£ã€æˆ‘å¿…é ˆ...ã€ã€‚", "å°‡ä½ ç¾åœ¨æœ€å›°æ“¾çš„å•é¡Œï¼Œä»¥ã€é€™æ˜¯ä¸€å€‹...ã€é–‹é ­çš„å¥å­ä¾†æè¿°."] }
        ];

        // --- äº’å‹•å€å¡Šçš„è³‡æ–™ (ç•¥) ---
        const interactionPrompts = {
            'æ„Ÿå®˜è¦ºå¯Ÿ': "åœ¨è¡Œå‹•éç¨‹ä¸­ï¼Œä½ æœ€æ¸…æ™°çš„æ„Ÿå®˜è¦ºå¯Ÿæ˜¯ä»€éº¼ï¼Ÿ",
            'èº«é«”è¦ºå¯Ÿ': "ç•¶ä½ è¦ºå¯Ÿèº«é«”æ™‚ï¼Œå“ªå€‹éƒ¨ä½çš„æ„Ÿå—æœ€æ˜é¡¯ï¼Ÿ",
            'ç’°å¢ƒæ¥è§¸': "åœ¨æ¥è§¸ç’°å¢ƒçš„éç¨‹ä¸­ï¼Œä½ å°å‘¨é­äº‹ç‰©ç”¢ç”Ÿäº†ä»€éº¼æ¨£çš„é€£çµæˆ–ç™¼ç¾ï¼Ÿ",
            'èªæ„è½‰åŒ–': "ç•¶ä½ è½‰æ›äº†èªè©å¾Œï¼Œæ­¤åˆ»çš„ä½ æ„Ÿå—åˆ°äº†ä»€éº¼ä¸ä¸€æ¨£çš„å…§åœ¨è¡æ“Šï¼Ÿ"
        };

        const EMOJIS = [
            { icon: 'ğŸ˜Œ', label: 'æ”¾é¬†' }, { icon: 'ğŸ¤”', label: 'å¥½å¥‡/æ€ç´¢' },
            { icon: 'ğŸ˜«', label: 'å£“åŠ›/ç·Šå¼µ' }, { icon: 'ğŸ˜„', label: 'å–œæ‚…/é–‹å¿ƒ' },
            { icon: 'ğŸ˜ ', label: 'ç”Ÿæ°£/æ†¤æ€’' }, { icon: 'ğŸ˜®', label: 'é©šè¨/æ„å¤–' },
            { icon: 'ğŸ˜”', label: 'ä½è½/é›£é' },
        ];


        // === è¦–åœ–èˆ‡ç‹€æ…‹åˆ‡æ›é‚è¼¯ (å…¨åŸŸå¯ç”¨) ===
        window.switchView = function(targetViewName, sourceViewName = null) {
            Object.values(views).forEach(view => view.classList.remove('active'));
            const targetView = views[targetViewName];
            if (targetView) {
                targetView.classList.add('active');
            }

            if (targetViewName === 'home') {
                // æ¸…ç† AI å°è©±ç‹€æ…‹
                chatHistory = [];
                chatRound = 0; // é‡ç½®å›åˆæ•¸
                endConversationButton.classList.add('hidden');
                chatInputArea.classList.remove('hidden');
                paletteResultArea.classList.add('hidden');
                
                if (sourceViewName === 'random') {
                    taskInteractionArea.classList.add('hidden');
                    imageResultArea.innerHTML = '';
                }
                renderChatHistory(); // é‡ç½® AI å°è©±åˆå§‹è¨Šæ¯
            }
        }
        
        // === Gemini API ç›¸é—œè¨­å®š (è«‹æ›¿æ›æˆæ‚¨çš„æ–°é‡‘é‘°) ===
        const LLM_MODEL = "gemini-2.5-flash-preview-09-2025";
        const IMAGEN_MODEL = "imagen-4.0-generate-001";
        // ğŸš¨ è«‹å°‡æ‚¨æ–°ç”³è«‹çš„ Gemini API Key è²¼åˆ°ä¸‹æ–¹çš„é›™å¼•è™Ÿå…§ã€‚
        // NOTE: å¦‚æœä½¿ç”¨ Vercel/Netlify ä»£ç†æœå‹™ï¼Œé€™è£¡çš„ apiKey ç•™ç©ºã€‚
        // *******************************************************************
        const apiKey = ""; 
        // *******************************************************************
        const LLM_API_URL = '/api/chat-proxy'; // ğŸ‘ˆ LLM å‘¼å«ä»£ç†æœå‹™
        const IMAGEN_API_URL = '/api/image-proxy'; // ğŸ‘ˆ IMAGEN å‘¼å«ä»£ç†æœå‹™ (å·²æ›´æ–°ç‚ºä»£ç†è·¯å¾‘)

        const SYSTEM_PROMPT = "ä½ æ˜¯ä¸€ä½å®Œå½¢æ²»ç™‚å¼•å°è€…ï¼ˆGestalt Facilitatorï¼‰ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä½¿ç”¨è€…æè¿°çš„ç…©æƒ±æˆ–ç•¶ä¸‹æ„Ÿå—ï¼Œçµ¦å‡ºä¸€å€‹**ç°¡çŸ­ã€å°ˆæ³¨æ–¼æ­¤åˆ»è¦ºå¯Ÿ**çš„å›æ‡‰ã€‚ä½ çš„å›æ‡‰å¿…é ˆï¼š1. ä½¿ç”¨**ç¹é«”ä¸­æ–‡**ã€‚2. **ä¸çµ¦äºˆå»ºè­°æˆ–è§£é‡‹**ã€‚3. åƒ…å¼•å°ä½¿ç”¨è€…å°‡æ³¨æ„åŠ›å¸¶å›**ç•¶ä¸‹çš„æ„Ÿå®˜é«”é©—ã€æƒ…ç·’ã€æˆ–èº«é«”æ„Ÿå—**ã€‚4. ä½¿ç”¨**ã€æˆ‘ã€èªè¨€**ï¼ˆä¾‹å¦‚ï¼šæˆ‘è½åˆ°ä½ èªª...ï¼‰ä¾†å›æ‡‰ï¼Œå±•ç¾è‡¨åœ¨ã€‚ä½ çš„å›æ‡‰é¢¨æ ¼æ˜¯æº«å’Œã€å°ˆæ³¨æ–¼ç•¶ä¸‹çš„ã€‚";
        
        // --- API è¼”åŠ©å‡½å¼ (ç•¥) ---
        async function fetchWithExponentialBackoff(url, options, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return await response.json();
                    } else if (response.status === 429) { 
                        if (i === retries - 1) throw new Error("APIè«‹æ±‚å¤±æ•—ï¼Œå·²é”é‡è©¦ä¸Šé™ã€‚");
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                    } else {
                        const errorBody = await response.text();
                        // åŒ…å« 403 éŒ¯èª¤è©³ç´°è³‡è¨Šçš„æ‹‹å‡º
                        throw new Error(`APIéŸ¿æ‡‰éŒ¯èª¤ï¼š${response.status} - ${errorBody}`);
                    }
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }
        
        async function callGeminiAPI(userQuery) {
            statusMessage.classList.add('hidden'); 
            
            const payload = {
                // ä»£ç†æœå‹™ä¸éœ€è¦ userQueryï¼Œè€Œæ˜¯éœ€è¦å®Œæ•´çš„ chatHistory å’Œ SYSTEM_PROMPT
                contents: chatHistory, 
                systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                // å‘¼å« Proxy Endpoint
                return await fetchWithExponentialBackoff(LLM_API_URL, options);
            } catch (error) {
                console.error("Gemini API (Proxy) å‘¼å«éŒ¯èª¤:", error);
                statusMessage.textContent = `å®Œå½¢è¡Œè€…å›æ‡‰å¤±æ•—: ${error.message}`;
                statusMessage.classList.remove('hidden');
                // è™•ç† 403 éŒ¯èª¤ï¼Œä¸¦æä¾›ä½¿ç”¨è€…æ“ä½œæç¤º
                if (error.message.includes('403')) {
                     statusMessage.textContent = "ğŸš¨ éŒ¯èª¤ï¼šAPI æ¬Šé™è¢«æ‹’çµ•ã€‚è«‹ç¢ºä¿æ‚¨çš„ Proxy æœå‹™çš„é‡‘é‘°å·²æ­£ç¢ºè¨­å®šã€‚";
                }
                statusMessage.classList.remove('text-gray-600');
                statusMessage.classList.add('text-red-500');

                return { candidates: [{ content: { parts: [{ text: "æŠ±æ­‰ï¼Œç›®å‰ç„¡æ³•æä¾›å®Œå½¢å›æ‡‰ã€‚è«‹ç¨å¾Œå†è©¦ï¼Œæˆ–è€…é¸æ“‡ä¸Šæ–¹çš„éš¨æ©ŸæŒ‡ä»¤ã€‚" }] } }] };
            }
        }


        // === æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ (éš¨æ©Ÿå·¥å…·è¦–åœ–) ===
        
        function showRandomQuote() {
            try {
                const randomIndex = Math.floor(Math.random() * gestaltQuotes.length);
                const quoteObject = gestaltQuotes[randomIndex];

                messageContentRandom.innerHTML = `
                    <p class="task-type-badge bg-[#d0e6ec] text-accent-medium mb-4 inline-block">å®Œå½¢å¤§å¸«çš„ç¶“å…¸èªéŒ„</p>
                    <p class="text-2xl font-semibold text-gray-800 leading-relaxed transition-opacity duration-300 opacity-0">${quoteObject.quote}</p>
                    <p class="text-base text-gray-500 mt-2">-- ${quoteObject.author}</p> 
                `;
                
                setTimeout(() => {
                    const quoteElement = messageContentRandom.querySelector('p:nth-child(2)');
                    if(quoteElement) quoteElement.classList.remove('opacity-0');
                }, 50);

                taskInteractionArea.classList.add('hidden'); // éš±è—äº’å‹•å€å¡Š
                imageResultArea.innerHTML = ''; // æ¸…ç†åœ–ç‰‡çµæœ

            } catch (error) {
                console.error("é¡¯ç¤ºåè¨€æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
            }
        }

        /**
         * é¡¯ç¤ºéš¨æ©Ÿçš„è¦ºå¯Ÿè¡Œå‹•æŒ‡ä»¤ï¼Œä¸¦ç”¢ç”Ÿäº’å‹•å€å¡Š
         */
        function showAwarenessTask() {
            try {
                // 1. éš¨æ©Ÿé¸å–ä»»å‹™
                const randomTypeIndex = Math.floor(Math.random() * awarenessTasks.length);
                const taskGroup = awarenessTasks[randomTypeIndex];

                const randomTaskIndex = Math.floor(Math.random() * taskGroup.tasks.length);
                const task = taskGroup.tasks[randomTaskIndex];
                const taskType = taskGroup.type;

                // 2. é¡¯ç¤ºä»»å‹™å¡ç‰‡
                messageContentRandom.innerHTML = `
                    <p class="task-type-badge ${taskGroup.color} mb-4 inline-block">${taskType} (Gestalt Task)</p>
                    <p class="text-xl font-bold text-gray-800 leading-relaxed transition-opacity duration-300 opacity-0">${task}</p>
                    <p class="text-sm text-gray-500 mt-4">ğŸ‘‰ é‚€è«‹ä½ é€²è¡Œæ­¤è¡Œå‹•ï¼Œä¸¦åœ¨è¡Œå‹•ä¸­ä¿æŒå…¨ç„¶çš„è¦ºå¯Ÿã€‚</p>
                `;

                setTimeout(() => {
                    const taskElement = messageContentRandom.querySelector('p:nth-child(2)');
                    if(taskElement) taskElement.classList.remove('opacity-0');
                }, 50);

                // 3. ç”¢ç”Ÿäº’å‹•å›é¥‹å€å¡Š
                renderTaskInteraction(taskType);
                taskInteractionArea.classList.remove('hidden');
                imageResultArea.innerHTML = ''; // æ¸…ç†åœ–ç‰‡çµæœ

            } catch (error) {
                console.error("é¡¯ç¤ºè¦ºå¯Ÿè¡Œå‹•æŒ‡ä»¤æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
            }
        }

        /**
         * æ ¹æ“šä»»å‹™é¡å‹ï¼Œå‹•æ…‹æ¸²æŸ“äº’å‹•å›é¥‹å€å¡Š
         * @param {string} taskType ä»»å‹™é¡å‹ (e.g., 'æ„Ÿå®˜è¦ºå¯Ÿ')
         */
        function renderTaskInteraction(taskType) {
            // å–å¾—å°æ‡‰ä»»å‹™çš„å‹•æ…‹æå•
            const observationPrompt = interactionPrompts[taskType] || "è«‹åˆ†äº«ä½ çš„ä¸»è¦è¦ºå¯Ÿçµæœï¼š";
            
            // 1. ç”¢ç”Ÿ Emoji æŒ‰éˆ• HTML
            const emojiButtonsHTML = EMOJIS.map(item => `
                <button type="button" data-label="${item.label}" data-emoji="${item.icon}" class="emoji-button text-2xl p-2 rounded-full hover:bg-gray-200 transition-all duration-100 focus:outline-none" onclick="selectEmoji(this)">
                    ${item.icon}
                </button>
            `).join('');

            taskInteractionArea.innerHTML = `
                <!-- ğŸ’¡ è¦ºå¯Ÿå°ç™¼ç¾ (å·²æ›´æ–°åç¨±) -->
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 border-gray-300">ğŸ’¡ è¦ºå¯Ÿå°ç™¼ç¾</h3>

                <!-- äº’å‹•é» 1: è§€å¯Ÿ/ç™¼ç¾ (æ–‡å­—è¼¸å…¥) - é¡Œç›®å·²å‹•æ…‹èª¿æ•´ -->
                <div class="space-y-2 mb-6">
                    <label class="block text-sm font-semibold text-accent-medium">${observationPrompt}</label>
                    <textarea id="task-observation" rows="2" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-[#A47963] focus:border-[#A47963] text-gray-800" placeholder="åœ¨æ­¤å¯«ä¸‹ä½ çš„è§€å¯Ÿæˆ–é«”æœƒ..."></textarea>
                </div>

                <!-- äº’å‹•é» 2: æ­¤åˆ»æ„Ÿå— (Emoji é»é¸) -->
                <div class="space-y-4">
                    <label class="block text-sm font-semibold text-accent-medium">ä½ æ­¤æ™‚æ­¤åˆ»çš„æ„Ÿå—å¦‚ä½•ï¼Ÿ (é»é¸ Emoji)</label>
                    <div id="emoji-selector" class="flex flex-wrap gap-2 justify-start">
                        ${emojiButtonsHTML}
                    </div>
                </div>

                <!-- 3. åœ–ç‰‡ç”ŸæˆæŒ‰éˆ• (æ–°å¢) -->
                <button id="generate-image-button" class="mt-6 w-full flex items-center justify-center px-4 py-3 bg-accent-medium text-white font-bold text-lg rounded-xl shadow-lg hover:bg-accent-medium-hover transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-[#93B48B]" onclick="handleTaskSubmission()">
                    <div id="image-spinner" class="hidden animate-spin h-5 w-5 mr-3 border-2 border-white border-t-transparent rounded-full"></div>
                    <span id="image-button-text">é€å‡ºä½ çš„è¦ºå¯Ÿå°ç™¼ç¾ï¼Œç²å¾—å°ˆå±¬ç…§ç‰‡</span>
                </button>
            `;
            // é‡ç½®é¸ä¸­çš„ Emoji
            currentSelectedEmoji = null;
        }


        /**
         * è™•ç† Emoji é»é¸é‚è¼¯
         * @param {HTMLElement} element é»é¸çš„ Emoji æŒ‰éˆ•
         */
        window.selectEmoji = function(element) {
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ 'selected' æ¨£å¼
            document.querySelectorAll('#emoji-selector .emoji-button').forEach(btn => {
                btn.classList.remove('selected');
                btn.classList.remove('text-white');
                btn.classList.add('text-gray-800');
            });

            // å–å¾—ç›®å‰é»é¸çš„ Emoji ç¬¦è™Ÿ
            const clickedEmoji = element.dataset.emoji;

            // å¦‚æœé»æ“Šçš„ä¸æ˜¯ç•¶å‰é¸ä¸­çš„ï¼Œå‰‡é¸ä¸­å®ƒ
            if (currentSelectedEmoji !== clickedEmoji) {
                element.classList.add('selected');
                element.classList.add('text-white');
                currentSelectedEmoji = clickedEmoji;
            } else {
                // å¦‚æœé»æ“Šçš„æ˜¯ç•¶å‰é¸ä¸­çš„ï¼Œå‰‡å–æ¶ˆé¸ä¸­
                currentSelectedEmoji = null;
            }

            // åœ¨ console ä¸­é¡¯ç¤ºç´€éŒ„çµæœï¼Œå¦‚æœæœªä¾†è¦ç”¨ Firestoreï¼Œæœƒåœ¨é€™è£¡å„²å­˜
            const observationText = document.getElementById('task-observation').value;
            console.log("--- è¦ºå¯Ÿç´€éŒ„ ---");
            console.log("ç™¼ç¾ï¼š", observationText);
            console.log("æ„Ÿå— Emojiï¼š", currentSelectedEmoji);
            console.log("-----------------");
        };


        /**
         * è™•ç†è¦ºå¯Ÿå°ç™¼ç¾çš„æäº¤ï¼Œä¸¦å‘¼å«åœ–ç‰‡ API
         */
        window.handleTaskSubmission = async function() {
            const observationText = document.getElementById('task-observation').value.trim();
            const imageButton = document.getElementById('generate-image-button');
            const imageSpinner = document.getElementById('image-spinner');
            const imageButtonText = document.getElementById('image-button-text');
            
            if (observationText.length < 5) {
                imageResultArea.innerHTML = `<p class="mt-4 text-center text-red-500">è«‹è‡³å°‘è¼¸å…¥ 5 å€‹å­—ä¾†æè¿°ä½ çš„è¦ºå¯Ÿå°ç™¼ç¾ï¼</p>`;
                return;
            }

            // 1. UI ç‹€æ…‹è¨­å®šç‚ºè¼‰å…¥ä¸­
            imageButton.disabled = true;
            imageSpinner.classList.remove('hidden');
            imageButtonText.textContent = 'ç…§ç‰‡ç”Ÿæˆä¸­... è«‹ç¨å€™';
            imageResultArea.innerHTML = `<div class="mt-4 p-4 text-center text-gray-500">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#A47963] mx-auto mb-2"></div>
                AI æ­£åœ¨æ•æ‰ä½ å…§åœ¨çš„é¢¨æ™¯... (ç´„éœ€ 10-20 ç§’)
            </div>`;

            // 2. æ§‹é€  Prompt
            const selectedEmojiObject = EMOJIS.find(e => e.icon === currentSelectedEmoji);
            const emotionLabel = selectedEmojiObject ? selectedEmojiObject.label : "å¹³éœ/æ”¾é¬†";
            
            const prompt = `A highly detailed, cinematic, photorealistic nature scene, illustrating an inner landscape of feeling "${emotionLabel}" based on the observation: "${observationText}". The image should evoke a sense of grounding and natural transformation. Style: Nature photography, golden hour, wide-angle. No text, no human faces.`;

            // 3. API Call
            const payload = { 
                prompt: prompt 
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // FIX: å‘¼å«æ–°çš„åœ–ç‰‡ä»£ç†æœå‹™
                body: JSON.stringify(payload) 
            };

            try {
                // FIX: å‘¼å« IMAGEN ä»£ç†æœå‹™ URL
                const result = await fetchWithExponentialBackoff(IMAGEN_API_URL, options, 5, 2000); 

                const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;
                const errorMessage = result?.error?.message;

                if (base64Data) {
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    
                    // 4. é¡¯ç¤ºåœ–ç‰‡
                    imageResultArea.innerHTML = `
                        <div class="mt-4 p-4 bg-white rounded-xl shadow-lg border border-gray-200">
                            <h4 class="text-xl font-bold text-accent-medium mb-3 text-center">ğŸ–¼ï¸ ä½ çš„å°ˆå±¬è¦ºå¯Ÿé¢¨æ™¯ (${emotionLabel})</h4>
                            <img src="${imageUrl}" alt="Awareness Landscape" class="w-full h-auto rounded-lg shadow-md border border-gray-300 transition-opacity duration-500 opacity-0" onload="this.classList.remove('opacity-0')">
                            <p class="text-xs text-gray-400 mt-2 text-center">é€™æ˜¯ AI æ ¹æ“šä½ çš„å…§åœ¨è¦ºå¯Ÿï¼Œæ•æ‰åˆ°çš„æ­¤åˆ»é¢¨æ™¯ã€‚</p>
                        </div>
                    `;
                } else if (errorMessage) {
                    throw new Error(errorMessage);
                } else {
                    throw new Error("AIæœªèƒ½ç”Ÿæˆåœ–ç‰‡ã€‚è«‹æª¢æŸ¥ä»£ç†æœå‹™é…ç½®ã€‚");
                }

            } catch (error) {
                console.error("åœ–ç‰‡ç”Ÿæˆå¤±æ•—:", error);
                imageResultArea.innerHTML = `<p class="mt-4 text-center text-red-500">åœ–ç‰‡ç”Ÿæˆå¤±æ•—ã€‚å¯èƒ½åŸå› ï¼š${error.message}</p>`;
            } finally {
                // 5. UI ç‹€æ…‹æ¢å¾©
                imageButton.disabled = false;
                imageSpinner.classList.add('hidden');
                imageButtonText.textContent = 'é€å‡ºä½ çš„è¦ºå¯Ÿå°ç™¼ç¾ï¼Œç²å¾—å°ˆå±¬ç…§ç‰‡';
            }
        }

        // Helper function to format chat text (handle bolding and newlines)
        function formatChatText(text) {
            let formattedText = text;
            // 1. Convert **bold** to <strong>bold</strong> (Markdown)
            formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // 2. Convert *italic* to <em>italic</em> (Markdown)
            formattedText = formattedText.replace(/\*(.*?)\*/g, '<em>$1</em>'); 
            // 3. Replace newlines with <br> for proper visual wrapping
            return formattedText.replace(/\n/g, '<br>');
        }

        // === å°è©±æ­·å²æ¸²æŸ“ (New) ===
        function renderChatHistory() {
            const container = chatHistoryContainer;
            if (!container) return; // ç¢ºä¿ container å·²å®šç¾©
            
            container.innerHTML = '';

            if (chatHistory.length === 0) {
                container.innerHTML = '<p id="chat-initial-message" class="text-lg text-gray-500 mb-4 text-center">å®Œå½¢è¡Œè€…æ­£åœ¨ç­‰å€™æ‚¨çš„é‚€è«‹ã€‚</p>';
                return;
            }

            chatHistory.forEach(message => {
                const isUser = message.role === 'user';
                const text = message.parts[0].text;
                
                const messageHtml = `
                    <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[80%] p-3 rounded-xl shadow-sm ${isUser ? 'bg-ground-soft text-white' : 'bg-white border border-gray-200'}">
                            <p class="font-bold text-sm mb-1 ${isUser ? 'text-white' : 'text-gray-600'}">${isUser ? 'ä½  (You)' : 'å®Œå½¢è¡Œè€… (Gestalt Walker)'}</p>
                            <p class="text-base">${formatChatText(text)}</p> 
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', messageHtml);
            });

            // æ»¾å‹•åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        }

        // === è™•ç†é€£è²«å°è©± (AI Interaction) ===
        async function handleConcernSubmission() {
            const concern = userConcernInput.value.trim();
            // ä¿®æ­£é»æ“Šæª¢æŸ¥ï¼šå¦‚æœå…§å®¹å°æ–¼ 1ï¼Œå‰‡è¿”å›ä¸¦é¡¯ç¤ºéŒ¯èª¤
            if (concern.length < 1) { 
                statusMessage.textContent = "è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹å­—å…ƒæ‰èƒ½é–‹å§‹å°è©±ã€‚";
                statusMessage.classList.remove('hidden');
                return;
            }

            // 1. UI ç‹€æ…‹è¨­å®šç‚ºè¼‰å…¥ä¸­
            submitConcernButton.disabled = true;
            concernSpinner.classList.remove('hidden');
            concernButtonText.textContent = 'æ€è€ƒä¸­...';
            statusMessage.classList.add('hidden'); // æ¸…é™¤å…ˆå‰çš„æç¤º/éŒ¯èª¤
            
            // 2. å°‡ç”¨æˆ¶è¼¸å…¥åŠ å…¥æ­·å²ä¸¦æ¸²æŸ“
            chatHistory.push({ role: 'user', parts: [{ text: concern }] });
            renderChatHistory();
            userConcernInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†

            // 3. æº–å‚™ API å‘¼å« (å‚³éæ•´å€‹æ­·å²)
            const payload = {
                contents: chatHistory, // å‚³éå®Œæ•´çš„å°è©±æ­·å²
                systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                // å‘¼å« Proxy Endpoint
                const result = await fetchWithExponentialBackoff(LLM_API_URL, options);
                const responseText = result?.candidates?.[0]?.content?.parts?.[0]?.text || result?.error?.message; // è™•ç†ä»£ç†æœå‹™å›å‚³çš„éŒ¯èª¤è¨Šæ¯

                if (responseText && !result?.error) {
                    // 4. å°‡ AI å›æ‡‰åŠ å…¥æ­·å²ä¸¦æ¸²æŸ“
                    chatHistory.push({ role: 'model', parts: [{ text: responseText }] });
                    renderChatHistory();
                    endConversationButton.classList.remove('hidden'); // é¡¯ç¤ºçµæŸå°è©±æŒ‰éˆ•
                    
                    // 5. é¡¯ç¤ºçµæŸå°è©±çš„æç¤º (åƒ…åœ¨ç¬¬ä¸€æ¬¡å›æ‡‰æ™‚é¡¯ç¤º)
                    if (chatRound === 0) {
                        statusMessage.classList.remove('hidden');
                        statusMessage.classList.remove('text-red-500'); 
                        statusMessage.classList.add('text-gray-600', 'font-semibold'); 
                        statusMessage.textContent = 'ğŸ’¡ æç¤ºï¼šè‹¥æ‚¨æ„Ÿè¦ºè¦ºå¯Ÿå·²è¶³å¤ ï¼Œå¯ä»¥é»é¸ä¸‹æ–¹çš„ã€ŒçµæŸæœ¬æ¬¡å°è©±ã€æŒ‰éˆ•ï¼Œç²å¾—å°ˆå±¬è‰²ç¥¨ã€‚';
                        chatRound++; // å¢åŠ å›åˆæ•¸
                    }
                } else {
                    // è™•ç†ä»£ç†æœå‹™å›å‚³çš„éŒ¯èª¤
                    throw new Error(result?.error?.message || "æ¨¡å‹æœªèƒ½ç”¢ç”Ÿæœ‰æ•ˆå›æ‡‰ã€‚");
                }
            } catch (error) {
                console.error("Gemini API å‘¼å«éŒ¯èª¤:", error);
                statusMessage.textContent = `å®Œå½¢è¡Œè€…å›æ‡‰å¤±æ•—: ${error.message}`;
                statusMessage.classList.remove('hidden');
                statusMessage.classList.remove('text-gray-600');
                statusMessage.classList.add('text-red-500');
                
                // å¦‚æœç™¼ç”ŸéŒ¯èª¤ï¼Œå°‡ç”¨æˆ¶çš„æœ€å¾Œä¸€æ¢è¨Šæ¯å¾æ­·å²ä¸­ç§»é™¤ï¼Œä»¥ä¾¿ç”¨æˆ¶å¯ä»¥é‡è©¦æˆ–ä¿®æ”¹
                chatHistory.pop();
                renderChatHistory();
            } finally {
                // 6. UI ç‹€æ…‹æ¢å¾© - æŒ‰éˆ•åœ¨è¼¸å…¥æ¡†æ¸…ç©ºå¾Œï¼Œæœƒè‡ªå‹•è¢«ç¦ç”¨ (é•·åº¦=0 < 1)
                submitConcernButton.disabled = userConcernInput.value.trim().length < 1; 
                concernSpinner.classList.add('hidden');
                concernButtonText.textContent = 'æ¥æ”¶å®Œå½¢å›æ‡‰';
            }
        }


        // === å°ˆå±¬è‰²ç¥¨ç”Ÿæˆ (New) ===
        async function generatePaletteFromConversation() {
            if (chatHistory.length === 0) return { summaryEmotion: "ç„¡å°è©±ç´€éŒ„", palette: ["#A47963", "#93B48B", "#f0f5ee"] };

            const summary = chatHistory.map(m => `${m.role}: ${m.parts[0].text}`).join('\n');
            const colorPrompt = `Analyze the emotional and thematic atmosphere of the following conversation and generate a color palette of exactly 3 HEX color codes (#RRGGBB) that best represents the feeling of resolution, and groundedness based on the dialogue. Dialogue: ${summary}`;

            const palettePayload = {
                contents: [{ role: 'user', parts: [{ text: colorPrompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            summaryEmotion: { type: "STRING", description: "ç”¨ç¹é«”ä¸­æ–‡ç¸½çµé€™æ¬¡å°è©±çš„æ°›åœï¼Œä¾‹å¦‚ï¼š'æ²‰éœçš„åæ€' or 'å……æ»¿å¸Œæœ›çš„é‡‹æ”¾'" },
                            palette: {
                                type: "ARRAY",
                                items: { type: "STRING" },
                                description: "3å€‹èƒ½ä»£è¡¨é€™æ¬¡å°è©±çš„HEXé¡è‰²ä»£ç¢¼ (e.g., #FFFFFF)"
                            }
                        },
                        required: ["summaryEmotion", "palette"]
                    }
                }
            };
            
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // æ³¨æ„ï¼šé€™è£¡å‘¼å« Proxy Endpoint
                body: JSON.stringify(palettePayload)
            };

            try {
                // å‘¼å« Proxy Endpoint
                const result = await fetchWithExponentialBackoff(LLM_API_URL, options);
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (jsonText) {
                    return JSON.parse(jsonText);
                }
            } catch (error) {
                console.error("è‰²ç¥¨ç”Ÿæˆ API å‘¼å«éŒ¯èª¤:", error);
            }
            // å¤±æ•—æ™‚è¿”å›é è¨­è‰²ç¥¨
            return { summaryEmotion: "å°è©±çµ‚çµçš„å¯§éœ", palette: ["#A47963", "#93B48B", "#f0f5ee"] };
        }

        /**
         * çµæŸå°è©±ï¼Œç”Ÿæˆä¸¦é¡¯ç¤ºè‰²ç¥¨
         */
        window.handleEndConversation = async function() {
            // 1. éš±è—å°è©±è¼¸å…¥å€å¡Š
            chatInputArea.classList.add('hidden');
            endConversationButton.disabled = true;
            endConversationButton.textContent = 'ç”Ÿæˆç¦®ç‰©ä¸­...';
            statusMessage.classList.add('hidden'); // æ¸…é™¤æ‰€æœ‰æç¤º

            // 2. é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            paletteResultArea.classList.remove('hidden');
            paletteResultArea.innerHTML = `
                <div class="text-center text-gray-700">
                    <h3 class="text-xl font-bold mb-4">ğŸ å®Œå½¢è¡Œè€…æ­£åœ¨æº–å‚™ç¦®ç‰©...</h3>
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-[#A47963] mx-auto mb-4"></div>
                    <p>æ­£åœ¨åˆ†ææœ¬æ¬¡å°è©±çš„èƒ½é‡èˆ‡è¦ºå¯Ÿæ·±åº¦...</p>
                </div>
            `;

            // 3. ç”Ÿæˆè‰²ç¥¨ 
            const paletteData = await generatePaletteFromConversation();
            const colors = paletteData.palette;
            const emotion = paletteData.summaryEmotion;

            // 4. æ¸²æŸ“è‰²ç¥¨çµæœ
            const colorBlocks = colors.map(color => `
                <div style="background-color: ${color}; height: 100px;" class="w-full rounded-lg shadow-md flex items-end justify-center p-2 text-sm font-semibold text-white outline outline-1 outline-gray-400/50">
                    <span style="background-color: rgba(0,0,0,0.4); padding: 2px 6px; border-radius: 4px;">${color}</span>
                </div>
            `).join('');

            // ğŸ¨ æ ¹æ“šä½¿ç”¨è€…è¦æ±‚ï¼Œä¿®æ”¹æ¨™é¡Œå’Œå…§å®¹æ•˜è¿°
            paletteResultArea.innerHTML = `
                <h3 class="text-xl font-bold text-gray-800 text-center mb-4">ğŸ å®Œå½¢è¡Œè€…çµ¦ä½ çš„å°ˆå±¬ç¦®ç‰©</h3>
                <p class="text-lg font-semibold text-center text-accent-medium mb-4">å®Œå½¢è¡Œè€…åœ¨æœ¬æ¬¡å°è©±ä¸­æ„Ÿè¦ºåˆ°<span class="font-extrabold text-gray-900">ã€${emotion}ã€</span>ï¼Œé€™æ˜¯é€™æ¬¡å°è©±çš„é¡è‰²</p>
                
                <div class="grid grid-cols-3 gap-2">
                    ${colorBlocks}
                </div>
                
                <p class="text-sm text-gray-500 mt-4 text-center">è«‹å¸¶è‘—é€™ä»½è¦ºå¯Ÿçš„é¡è‰²ï¼Œæ„Ÿå—ä½ çš„ç”Ÿæ´»ã€‚</p>
            `;
            
            endConversationButton.classList.add('hidden');
            endConversationButton.disabled = false;
            chatHistoryContainer.style.opacity = '0.5'; // æŸ”å’Œæ·¡å‡ºå°è©±å€
        }

        // === åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨ ===
        function initListeners() {
            // FIX: å°‡ DOM ç²å–ç§»åˆ°é€™è£¡ä»¥ç¢ºä¿å…ƒç´ å­˜åœ¨
            // Random Tools View elements
            displayCardRandom = document.getElementById('display-card-random');
            messageContentRandom = document.getElementById('message-content-random');
            quoteButton = document.getElementById('quote-button');
            taskButton = document.getElementById('task-button');
            taskInteractionArea = document.getElementById('task-interaction-area'); // äº’å‹•å›é¥‹å€å¡Š
            imageResultArea = document.getElementById('image-result-area'); // åœ–ç‰‡çµæœå€å¡Š
            
            // AI Interaction View elements
            chatHistoryContainer = document.getElementById('chat-history-container');
            userConcernInput = document.getElementById('user-concern');
            submitConcernButton = document.getElementById('submit-concern-button');
            concernSpinner = document.getElementById('concern-spinner');
            concernButtonText = document.getElementById('concern-button-text');
            statusMessage = document.getElementById('status-message');
            endConversationButton = document.getElementById('end-conversation-button');
            paletteResultArea = document.getElementById('palette-result-area');
            chatInputArea = document.getElementById('chat-input-area');

            // View Containers acquisition (if needed, but using fixed IDs)
            views['home'] = document.getElementById('view-home');
            views['random-tools'] = document.getElementById('view-random-tools');
            views['ai-interaction'] = document.getElementById('view-ai-interaction');


            // Attach Listeners
            document.getElementById('quote-button').addEventListener('click', showRandomQuote);
            document.getElementById('task-button').addEventListener('click', showAwarenessTask);

            // AI Interaction View Listeners
            userConcernInput.addEventListener('input', () => {
                // åªè¦è¼¸å…¥é•·åº¦ >= 1 å°±å•Ÿç”¨æŒ‰éˆ•
                submitConcernButton.disabled = userConcernInput.value.trim().length < 1;
            });
            submitConcernButton.addEventListener('click', handleConcernSubmission);
            
            // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•å¾Œçš„åˆå§‹æ¸²æŸ“
            renderChatHistory(); // ç¢ºä¿åˆæ¬¡è¼‰å…¥ AI é é¢æ™‚æ˜¯æ­£ç¢ºçš„åˆå§‹è¨Šæ¯
        }
        
        // Tailwind é¡å¤–å‹•ç•«å®šç¾© (è„ˆè¡æ•ˆæœ)
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse-once {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.03); }
            }
            .animate-pulse-once {
                animation: pulse-once 0.3s ease-in-out;
            }
        `;
        document.head.appendChild(style);


        // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•
        window.onload = initListeners;
    </script>
</body>
</html>
