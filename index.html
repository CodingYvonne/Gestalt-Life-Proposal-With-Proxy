<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œå½¢ç”Ÿæ´»ææ¡ˆ - Gestalt Life Proposal</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­å®šå­—é«”ç‚º Interï¼Œä¸¦åŠ å…¥ä¸­æ–‡æ”¯æ´ (æ”¹ç‚º Noto Serif TC / æ€æºå®‹é«”) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Serif+TC:wght@200..900&display=swap');
        body {
            /* ä¸»è¦å­—é«”å¾ Noto Sans TC æ”¹ç‚º Noto Serif TC (æ˜é«”/å®‹é«”) */
            font-family: 'Noto Serif TC', 'Inter', serif; 
            
            /* ğŸ¨ ä¿æŒä½¿ç”¨ç¾æœ‰å…¬é–‹é€£çµçš„èƒŒæ™¯åœ–ç‰‡ */
            background-color: #A47963; /* åœ–ç‰‡è¼‰å…¥å¤±æ•—æ™‚çš„å‚™ç”¨è‰² */
            background-image: url('https://images.unsplash.com/photo-1549495034-728b7e283287?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'); 
            background-size: cover;
            background-attachment: fixed;
            background-position: center center;
            /* ----------------------- */
        }
        .task-type-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        
        /* ğŸ¨ å°‡æ‰€æœ‰åŸæ·±é’è‰² (#074F57) çš„åœ°æ–¹æ”¹ç‚º #A47963 */
        .bg-primary-dark { background-color: #A47963; } 
        .hover\:bg-primary-dark-hover:hover { background-color: #926A57; }
        
        /* Accent Medium ç¾åœ¨èˆ‡ Primary Dark é¡è‰²ç›¸åŒ */
        .bg-accent-medium { background-color: #A47963; } 
        .hover\:bg-accent-medium-hover:hover { background-color: #926A57; }
        
        .bg-ground-soft { background-color: #93B48B; }
        .hover\:bg-ground-soft-hover:hover { background-color: #7a9973; }
        
        /* ğŸ¨ å°ˆå±¬é¡è‰²å®šç¾© */
        .text-primary-dark { color: #A47963; } 
        .text-accent-medium { color: #A47963; } 
        .bg-end-conversation { background-color: #5A352A; } /* ğŸ‘ˆ æ–°å¢çµæŸå°è©±æŒ‰éˆ•çš„é¡è‰² */
        .hover\:bg-end-conversation-hover:hover { background-color: #492a21; }
        
        .border-ground-soft { border-color: #93B48B; }
        .bg-very-light-green { background-color: #f0f5ee; }

        /* éš±è—/é¡¯ç¤ºè¦–åœ–çš„åŸºç¤æ¨£å¼ */
        .view { display: none; }
        .view.active { display: block; }

        .emoji-button {
            transition: transform 0.1s ease-in-out, background-color 0.1s ease-in-out;
            color: #1f2937; /* é è¨­æ·±ç°å­— */
        }
        .emoji-button:hover {
            transform: scale(1.2);
        }
        .emoji-button.selected {
            background-color: #A47963;
            transform: scale(1.15);
            color: white; /* é¸ä¸­å¾Œè®Šç™½å­— */
        }
        /* Chat Bubble Styles */
        #chat-history-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 0.75rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼å®¹å™¨ (èƒŒæ™¯ç‚ºç™½è‰²ï¼Œåœ¨ #A47963 åº•è‰²ä¸Šæ¸…æ™°æµ®ç¾) -->
    <div id="app-container" class="w-full max-w-lg bg-white rounded-3xl shadow-xl overflow-hidden transform transition-all duration-300">
        
        <!-- æ¨™é¡Œå€ (BG: #A47963) -->
        <header class="bg-primary-dark p-6">
            <h1 class="text-3xl font-extrabold text-white text-center">å®Œå½¢ç”Ÿæ´»ææ¡ˆ</h1>
            <p class="text-sm text-gray-200 text-center mt-1">Gestalt Life Proposal</p>
        </header>

        <!-- å…§å®¹é¡¯ç¤ºå€ -->
        <main class="p-6 md:p-8">
            
            <!-- è¦–åœ–å®¹å™¨ -->
            <div id="views-container" class="space-y-6">

                <!-- 1. èµ·å§‹ç•«é¢ (VIEW_HOME) -->
                <div id="view-home" class="view active">
                    <div class="min-h-[150px] flex flex-col justify-center items-center text-center p-6 rounded-xl transition-all duration-500">
                        <p class="text-xl text-gray-700 font-semibold mb-6">æ­¡è¿ä¾†åˆ°å®Œå½¢è¦ºå¯Ÿçš„æ­¤åˆ»ã€‚</p>
                        
                        <!-- å°è¦½æŒ‰éˆ• -->
                        <div class="space-y-4 w-full">
                            <!-- ğŸ¨ BG: #93B48B, Text: White (ä¾æ“šè¦æ±‚) -->
                            <button onclick="switchView('random-tools')" class="w-full px-4 py-3 bg-ground-soft text-white font-bold text-lg rounded-xl shadow-lg hover:bg-ground-soft-hover transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98]">
                                æˆ‘æƒ³éš¨æ©Ÿç²å¾—è¡Œå‹•æŒ‡ä»¤
                            </button>
                            <!-- ğŸ¨ BG: #A47963 -->
                            <button onclick="switchView('ai-interaction')" class="w-full px-4 py-3 bg-accent-medium text-white font-bold text-lg rounded-xl shadow-lg hover:bg-accent-medium-hover transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98]">
                                æˆ‘æƒ³è·Ÿå®Œå½¢è¡Œè€…å°è©± <!-- ğŸ‘ˆ å·²æ›´æ–°åç¨± -->
                            </button>
                        </div>

                        <p class="text-sm text-gray-500 mt-6">è«‹é¸æ“‡ä½ ç•¶ä¸‹æƒ³åšçš„è¦ºå¯Ÿç·´ç¿’ã€‚</p>
                    </div>
                </div>

                <!-- 2. éš¨æ©ŸæŒ‡ä»¤ç•«é¢ (VIEW_RANDOM_TOOLS) -->
                <div id="view-random-tools" class="view">
                    <!-- é¡¯ç¤ºå¡ç‰‡ -->
                    <div id="display-card-random" class="min-h-[150px] flex flex-col justify-center items-center text-center bg-very-light-green border border-ground-soft p-6 rounded-xl shadow-inner transition-all duration-500">
                        <div id="message-content-random">
                            <p class="text-lg text-gray-500 mb-4">è«‹é¸æ“‡ä¸‹æ–¹æŒ‡ä»¤ï¼Œé–‹å§‹è¦ºå¯Ÿã€‚</p>
                        </div>
                    </div>
                    
                    <!-- ğŸ’¡ è¦ºå¯Ÿå°ç™¼ç¾ (äº’å‹•å›é¥‹å€å¡Š) -->
                    <div id="task-interaction-area" class="mt-6 p-4 bg-gray-50 rounded-xl border border-gray-200 hidden">
                        <!-- å‹•æ…‹å…§å®¹å°‡æœƒè¢«æ’å…¥æ­¤è™• -->
                    </div>
                    
                    <!-- ğŸ–¼ï¸ åœ–ç‰‡çµæœå€å¡Š (æ–°å¢) -->
                    <div id="image-result-area" class="mt-6">
                        <!-- åœ–ç‰‡å’Œè¼‰å…¥ç‹€æ…‹æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>

                    <!-- æŒ‰éˆ•æ“ä½œå€ -->
                    <div class="mt-6 space-y-4">
                        <!-- æ ¸å¿ƒåŠŸèƒ½ä¸€ï¼šå®Œå½¢å¤§å¸«çš„ç¶“å…¸èªéŒ„ (BG: #A47963) -->
                        <button id="quote-button" class="w-full flex items-center justify-center px-4 py-3 bg-primary-dark text-white font-bold text-lg rounded-xl shadow-lg hover:bg-primary-dark-hover transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-[#93B48B]">
                            <span class="mr-2 text-xl">âœ¨</span> å®Œå½¢å¤§å¸«çš„ç¶“å…¸èªéŒ„
                        </button>
                        
                        <!-- æ ¸å¿ƒåŠŸèƒ½äºŒï¼šè¦ºå¯Ÿè¡Œå‹•æŒ‡ä»¤ (BG: #93B48B, Text: White) -->
                        <button id="task-button" class="w-full flex items-center justify-center px-4 py-3 bg-ground-soft text-white font-bold text-lg rounded-xl shadow-lg hover:bg-ground-soft-hover transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-[#a8c99f]">
                            <span class="mr-2 text-xl">ğŸŒªï¸</span> å®Œå½¢çš„è¦ºå¯Ÿè¡Œå‹•
                        </button>
                    </div>
                    
                    <button onclick="switchView('home', 'random')" class="mt-6 w-full text-sm text-gray-500 hover:text-primary-dark transition duration-150 py-2 rounded-lg border border-gray-300 hover:border-primary-dark">â† è¿”å›èµ·å§‹é </button>
                </div>

                <!-- 3. ç…©æƒ±äº’å‹•ç•«é¢ (VIEW_AI_INTERACTION) -->
                <div id="view-ai-interaction" class="view">
                    
                    <!-- å°è©±æ­·å²å®¹å™¨ -->
                    <div id="chat-history-container" class="min-h-[150px] space-y-4 p-4 bg-very-light-green border border-ground-soft transition-all duration-500">
                        <p id="chat-initial-message" class="text-lg text-gray-500 mb-4 text-center">å®Œå½¢è¡Œè€…æ­£åœ¨ç­‰å€™æ‚¨çš„é‚€è«‹ã€‚</p> <!-- ğŸ‘ˆ å·²æ›´æ–°æ–‡å­— -->
                    </div>

                    <!-- è‰²ç¥¨çµæœå€å¡Š (é è¨­éš±è—) -->
                    <div id="palette-result-area" class="mt-6 p-4 bg-gray-50 rounded-xl border border-gray-200 hidden">
                        <!-- å°ˆå±¬è‰²ç¥¨å°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>

                    <!-- äº’å‹•è¼¸å…¥å€åŸŸ (Chat Input) -->
                    <div id="chat-input-area" class="mt-6 space-y-3 p-4 bg-gray-50 rounded-xl border border-gray-200">
                        <label for="user-concern" class="block text-sm font-bold text-gray-700">ğŸ’¬ å¯«ä¸‹ä½ ç¾åœ¨çš„ç…©æƒ±æˆ–ç•¶ä¸‹æ„Ÿå—ï¼š</label>
                        <textarea id="user-concern" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#A47963] focus:border-[#A47963] transition duration-150 text-gray-800" placeholder="ä¾‹å¦‚ï¼šæˆ‘å°æœŸæœ«å ±å‘Šæ„Ÿåˆ°éå¸¸ç„¦æ…®ï¼Œè¦ºå¾—è‡ªå·±åšä¸åˆ°..."></textarea>
                        <!-- æäº¤æŒ‰éˆ• (BG: #A47963) -->
                        <button id="submit-concern-button" class="w-full flex items-center justify-center px-4 py-3 bg-accent-medium text-white font-bold text-lg rounded-xl shadow-lg hover:bg-accent-medium-hover transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-[#93B48B] disabled:opacity-50" disabled>
                            <div id="concern-spinner" class="hidden animate-spin h-5 w-5 mr-3 border-2 border-white border-t-transparent rounded-full"></div>
                            <span id="concern-button-text">æ¥æ”¶å®Œå½¢å›æ‡‰</span>
                        </button>
                    </div>
                    
                    <!-- çµæŸå°è©±æŒ‰éˆ• (æ–°å¢) -->
                    <!-- ğŸ¨ é¡è‰²æ”¹ç‚º #5A352A -->
                    <button id="end-conversation-button" class="mt-6 w-full text-sm text-white font-bold px-4 py-3 bg-end-conversation rounded-xl shadow-md hover:bg-end-conversation-hover transition duration-150 focus:outline-none focus:ring-4 focus:ring-[#926A57] hidden" onclick="handleEndConversation()">
                        çµæŸæœ¬æ¬¡å°è©±
                    </button>

                    <!-- éŒ¯èª¤/æç¤ºè¨Šæ¯ -->
                    <div id="status-message" class="mt-4 text-center text-gray-600 hidden"></div> <!-- èª¿æ•´ç‚ºä¸­æ€§é¡è‰²ï¼Œç”¨æ–¼æç¤º -->

                    <button onclick="switchView('home', 'ai')" class="mt-4 w-full text-sm text-gray-500 hover:text-primary-dark transition duration-150 py-2 rounded-lg border border-gray-300 hover:border-primary-dark">â† è¿”å›èµ·å§‹é </button>
                </div>

            </div>

        </main>
        <!-- Footer ç§»é™¤ï¼ŒæŒ‰éˆ•å·²ç§»è‡³å„è¦–åœ–å…§ -->

    </div>

    <script>
        // === å…¨åŸŸè®Šæ•¸å®£å‘Š (ç”¨æ–¼å„²å­˜ DOM å…ƒç´ ) ===
        let chatHistory = [];
        let currentSelectedEmoji = null; 
        let chatRound = 0; // æ–°å¢å°è©±å›åˆè¨ˆæ•¸å™¨
        
        let displayCardRandom;
        let messageContentRandom;
        let quoteButton;
        let taskButton;
        let taskInteractionArea; 
        let imageResultArea; 
        
        let userConcernInput;
        let submitConcernButton;
        let concernSpinner;
        let concernButtonText;
        let statusMessage;
        let endConversationButton;
        let paletteResultArea;
        let chatInputArea;
        let chatHistoryContainer;

        const views = {
            'home': null,
            'random-tools': null,
            'ai-interaction': null
        };
        
        // --- å®Œå½¢åè¨€æ•¸æ“š (ç•¥) ---
        const gestaltQuotes = [
            { quote: "æˆ‘åšæˆ‘çš„äº‹ï¼Œä½ åšä½ çš„äº‹ã€‚", author: "Fritz Perls" },
            { quote: "å¤±å»ç†æ™ºï¼Œæ‰¾å›æ„Ÿå®˜ã€‚ (Lose your mind and come to your senses.)", author: "Fritz Perls" },
            { quote: "ç„¦æ…®æ˜¯å¾ã€ç¾åœ¨ã€åˆ°ã€æœªä¾†ã€ä¹‹é–“çš„ç¸«éš™ã€‚", author: "Fritz Perls" },
            { quote: "æ´»åœ¨ç•¶ä¸‹ã€‚", author: "Fritz Perls" },
            { quote: "è²¬ä»»ï¼Œæ˜¯ä½ å¯ä»¥å›æ‡‰çš„èƒ½åŠ›ã€‚", author: "Fritz Perls" },
            { quote: "å”¯æœ‰é«”é©—æ‰èƒ½äº†è§£ã€‚", author: "Fritz Perls" },
            { quote: "è¦ºå¯Ÿå³ç™‚ç™’ã€‚", author: "Fritz Perls" },
            { quote: "å®Œæˆæœªç«Ÿäº‹å‹™ã€‚", author: "Fritz Perls" },
            { quote: "æ¥è§¸èˆ‡é€€ç¸®çš„ç¯€å¥ã€‚", author: "Fritz Perls" },
            { quote: "å¾ã€æ‡‰è©²ã€è½‰å‘ã€æ˜¯ã€ã€‚", author: "Fritz Perls" },
            { quote: "ä¸€å€‹äººç•¶ä»–å‚¾å‘æŠ•å°„æ™‚ï¼Œå°±å¥½åƒæŸäººååœ¨æˆ¿å­è£¡é¢ï¼Œå‰é¢æ˜¯ä¸€é¢é¡å­ï¼Œæ¯ç•¶ä»–å¾€å¤–çœ‹ï¼Œä»–ä»¥ç‚ºå¾ç»ç’ƒçœ‹åˆ°å¤–é¢çš„ä¸–ç•Œï¼Œäº‹å¯¦ä¸Šä»–çœ‹åˆ°çš„æŒ‡æ˜¯ä»–è‡ªå·±", author: "Fritz Perls" },
            
            // è¬æ›œä»»è€å¸«èªéŒ„ (New)
            { quote: "æ˜¯ä»€éº¼é˜»æ“‹äº†ä½ ï¼Ÿ", author: "è¬æ›œä»»" },
            { quote: "å¾ˆå¥½å–”ï¼", author: "è¬æ›œä»»" },
            { quote: "å®Œå½¢çš„æ ¸å¿ƒä¸æ˜¯ã€Œæ²»ç™‚ã€ï¼Œè€Œæ˜¯ã€Œè›»è®Šã€", author: "è¬æ›œä»»" },
            { quote: "Gestalt æœ¬é«”æ˜¯ã€Œé“ã€ï¼šè‡ªç„¶é‹ä½œçš„ç™‚ç™’æ€§ï¼Œäººå¤©ç”Ÿå°±æœ‰ç™‚ç™’è‡ªå·±çš„èƒ½åŠ›ï¼Œæ²»ç™‚åœ¨åšçš„æ˜¯æ¬é–‹å¡ä½è‡ªå·±çš„éƒ¨åˆ†", author: "è¬æ›œä»»" },
            { quote: "åœ¨é—œä¿‚ç•¶ä¸­ï¼Œè¦ªå¯†èˆ‡è‡ªä¸»æ°¸é æ˜¯å€‹é‡è¦è­°é¡Œ", author: "è¬æ›œä»»" },
            { quote: "å¸¶è‘—è¦ºå¯Ÿäº†è§£ä½•è¬‚éå»ã€ä½•è¬‚ç¾åœ¨ã€å·®åˆ¥ç‚ºä½•ï¼Œå³æ˜¯æ”¹è®Šçš„åŸºç¤", author: "è¬æ›œä»»" },
            { quote: "å®Œå½¢çš„æ­·ç¨‹ä¸æ˜¯ã€Œæƒ³ã€å‡ºä¾†çš„ã€ŒæŠ€å·§ã€ï¼Œè€Œæ˜¯åœ¨ç•¶ä¸‹è·Ÿå€‹æ¡ˆäº’å‹•å‡ºä¾†çš„", author: "è¬æ›œä»»" },
            { quote: "è¶Šä¾†è¶Šæ¥è¿‘æ¨¡ç³Šã€è¶Šä¾†è¶Šç„¡çŸ¥ï¼Œä½†è¶Šä¾†è¶Šæœ‰åŠ›é‡ã€è¶Šä¾†è¶Šèƒ½å¤ è·Ÿæ›´å¤§çš„æˆ‘ç›¸è™•ã€æ•´åˆ", author: "è¬æ›œä»»" },
            { quote: "éå»å¡ä½çš„äº‹æƒ…ä¸€å®šå°æ–¼ç•¶æ™‚æœ‰åŠŸèƒ½ï¼Œé€²ä¸€æ­¥å»ç­è§£ã€Œå¡ã€æƒ³è¦å¹«åŠ©æˆ‘ä»€éº¼", author: "è¬æ›œä»»" },
            { quote: "ä½æ„Ÿè¦ºæ˜¯æ¥è§¸å¹²æ“¾ä¸­æœ€ç‚ºåš´é‡çš„ï¼Œæ˜¯ä¸€ç¨®è®“è‡ªå·±èº«é«”éº»æœ¨çš„éç¨‹", author: "è¬æ›œä»»" },
            
            // Enright èªéŒ„ (New)
            { quote: "å®Œå½¢æ²»ç™‚çš„ä¸€å€‹æ ¸å¿ƒç‰¹è‰²ï¼Œå³æ˜¯æ¡ˆä¸»ç›¡å¯èƒ½çš„è‡ªå·±æ²»ç™‚è‡ªå·±", author: "Enright (1971, p.120)" },
        ];

        // --- è¦ºå¯Ÿè¡Œå‹•æŒ‡ä»¤æ•¸æ“š (ç•¥) ---
        const awarenessTasks = [
            { type: 'æ„Ÿå®˜è¦ºå¯Ÿ', color: 'bg-[#f0f5ee]
